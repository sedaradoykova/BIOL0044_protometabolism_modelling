---
output:
  pdf_document: default
---


```{r setup, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.pos = "!H", out.extra = "")
library("GillespieSSA")
library("ggplot2")
library("patchwork")
library("stringr")
# SOURCE .RDATA FILE of Lias matrices (.csv)
load(file = "lia_matrices.RData")
source(file = "dependencies/plt_fnc.R") # plotting function
```

```{r out.width="20%"}
#knitr::include_graphics("CO2_fixation_diagram.png")
```

# Reversible reaction simulation for simple carbon fixation

My aim was to introduce reversible reactions to the code written by the summer student. Previous attempts to encode reversible reactions seemed to lead to crashes. The results below indicate that the simulation  works in principle and that the reversibility of the reactions _per se_ does not cause a crash. <br> <br>
The simulations of forward reactions (in black) yield plots very similar to simulations of reversible reactions with negligibly small backward reaction rates (in red). The plots below show that when the backward reaction is $10^2$ times slower than its forward counterpart, slight differences in the simulation results could be observed, particularly for $CO$ and acetic acid. When the rate of the forward reaction was $10^3$ times greater than the backward reaction rate, there was virtually no difference between the unidirectional and reversible simulations. <br> <br>
However, when forward and backward reaction rates are equal (in blue), the simulation is truncated early and an error message is displayed, `negative propensity function - coersing to zero`. In other words, we sometimes observe negative values _e.g._ for formaldehyde, methanol, $CO$, acetate, $H_2O$. In some simulations, the number of $CO_2$ and $H_2$ molecules surpses the initial input values. This could be caused both by the low numbers of chemical species and by the fact that certain reactants are depleted (and/or replenished) by multiple reactions. Possible solutions would include adjusting the time-step or the relative magnitude of the forward and backward reaction rates to push the system away from chemical equilibrium. <br> <br>
_Note that not all features described here might be seen in the plots below, as every simulation yields slightly different resuls._ <br><br>

## Reactions, Parameters, and Conditions

The reactions and parameters used in the simulations are summarised below: 

| Forward reactions | Parameters |
|-------------------|------------|
| $k_{1}*CO_{2}*H_{2}$ | $k_{1} = 10$ |
| $k_{2}*formic\ acid*H_{2}$ | $k_{2} = 19.9$ |
| $k_{3}*formaldehyde*H_{2}$ | $k_{3} = 23.5$ |
| $k_{4}*methanol*CO$ | $k_{4} = 0.869$ |
| $k_{5}*CO_{2}*H_{2}$ | $k_{5} = 0.061$ |
| $20*formic\ acid$ | |

Conditions kept constant across simulations: 

* initial reactants numbers: $CO_{2} = H_{2} = 500\ mol$
* timestep size: tf = $0.0005$ 
<br> <br>



``` {r carbon fixation new, warning=FALSE, echo=FALSE}
#### BLACK Forward reactions (Lia's simulation)
# no_cofactors

parms_k <- c(
  k_1 = 10,
  k_2 = 19.9,
  k_3 = 23.5,
  k_4 = 0.869,
  k_5 = 0.061
) 
nmol <- 5000

#initial concentrations of reactants and products involved 
x_c_fix <- c(CO2 = nmol, H2 = nmol, formic_acid = 0,
        formaldehyde = 0, methanol = 0, CO = 0, acetic_acid = 0, H2O = 0) 

a_c_fix <- #carbon fixation
  c(
    "k_1*CO2*H2",
    "k_2*formic_acid*H2",
    "k_3*formaldehyde*H2",
    "k_4*methanol*CO",
    "k_5*CO2*H2",
    "20*formic_acid"
  )

# state change matrix
mat_c_fix <- as.matrix(csvs_matrices$no_cofactors[,-1])

out_c_fix <- ssa(x0 = x_c_fix, a = a_c_fix, 
                      nu = mat_c_fix, parms = parms_k, 
                      tf = 0.0005, method = ssa.d())

# cat("Why is the sum of the matrix =", sum(mat_co_fix_new), "???")
#cat("Output dim =", dim(out_co_fix_new$data))
```

```{r}
fwd = plt_fnc(
  to_plot = colnames(out_c_fix[["data"]])[-1], 
  data = out_c_fix[["data"]], col = "black"
  )
#for (i in 1:16) cat("p1[[", i, "]] + ", sep = "")
#fwd[[1]] + fwd[[2]] + fwd[[3]] + fwd[[4]] + fwd[[5]] + fwd[[6]] + fwd[[7]] + fwd[[8]]
```


```{r}
# initial concentrations of reactants and products involved 
nmol <- 5000

x_rev_c_fix <- c(
    CO2 = nmol,
    H2 = nmol,
    formic_acid = 0,
    formaldehyde = 0,
    methanol = 0,
    CO = 0,
    acetic_acid = 0,
    H2O = 0) 

a_rev_c_fix <- c( # carbon fixation
                  "k_1*CO2*H2",
                  "k_1a*CO2*H2",
                  "k_2*formic_acid*H2",
                  "k_2a*formic_acid*H2",
                  "k_3*formaldehyde*H2",
                  "k_3a*formaldehyde*H2",
                  "k_4*methanol*CO",
                  "k_4a*methanol*CO",
                  "k_5*CO2*H2",
                  "k_5a*CO2*H2",
                  "20*formic_acid",
                  "20*formic_acid")

# state change matrix
mat_rev_c_fix <- as.matrix(read.csv("reversible_c_fix.csv", header = F)[-1])
```




```{r}
#### RED Reversible reactions - negligible backward rates

# parameters
parms_k <- c(k_1 = 10, k_1a = 0.01, 
             k_2 = 19.9, k_2a = 0.199, 
             k_3 = 23.5, k_3a = 0.235, 
             k_4 = 0.869, k_4a = 0.00869, 
             k_5 = 0.061, k_5a = 0.00061)

#output
out_rev_c_fix <- ssa(x0 = x_rev_c_fix, 
                      a = a_rev_c_fix, 
                      nu = mat_rev_c_fix,
                      parms = parms_k, 
                      tf = 0.0005, verbose = F)
#cat("Output dim =", dim(out_rev_c_fix$data))

rev_negl = plt_fnc(
  to_plot = colnames(out_rev_c_fix[["data"]])[-1], 
  data = out_rev_c_fix[["data"]], col = "red"
  )
#for (i in 1:16) cat("p1[[", i, "]] + ", sep = "")
#rev_negl[[1]] + rev_negl[[2]] + rev_negl[[3]] + rev_negl[[4]] + rev_negl[[5]] + rev_negl[[6]] + rev_negl[[7]] + rev_negl[[8]]
```




```{r}
#### BLUE Reversible reactions - equal forward/backward rates

# parameters
parms_k <- c(k_1 = 10, k_1a = 10, 
             k_2 = 19.9, k_2a = 19.9, 
             k_3 = 23.5, k_3a = 23.5, 
             k_4 = 0.869, k_4a = 0.869, 
             k_5 = 0.061, k_5a = 0.061)

x_rev_c_fix_eq = x_rev_c_fix

a_rev_c_fix_eq = a_rev_c_fix

#output
out_rev_c_fix <- ssa(x0 = x_rev_c_fix_eq, 
                      a = a_rev_c_fix_eq, 
                      nu = mat_rev_c_fix,
                      parms = parms_k, 
                      tf = 0.0005, verbose = F)
#cat("Output dim =", dim(out_rev_c_fix$data))

rev_eq = plt_fnc(
  to_plot = colnames(out_rev_c_fix[["data"]])[-1], 
  data = out_rev_c_fix[["data"]], col = "blue"
  )
#for (i in 1:16) cat("p1[[", i, "]] + ", sep = "")
#rev_eq[[1]] + rev_eq[[2]] + rev_eq[[3]] + rev_eq[[4]] + rev_eq[[5]] + rev_eq[[6]] + rev_eq[[7]] + rev_eq[[8]]
```


\newpage

```{r fig.height=3.5}
#for (i in 1:8) cat("fwd[[", i, "]] + ","rev_negl[[", i, "]] + ", "rev_eq[[", i, "]] + ", sep = "")
fwd[[1]] + rev_negl[[1]] + rev_eq[[1]] + fwd[[2]] + rev_negl[[2]] + rev_eq[[2]]
```

```{r fig.height=3.5}
fwd[[3]] + rev_negl[[3]] + rev_eq[[3]] + fwd[[4]] + rev_negl[[4]] + rev_eq[[4]]
```

```{r fig.height=3.5}
fwd[[5]] + rev_negl[[5]] + rev_eq[[5]] + fwd[[6]] + rev_negl[[6]] + rev_eq[[6]]
```

```{r fig.height=3.5}
fwd[[7]] + rev_negl[[7]] + rev_eq[[7]] + fwd[[8]] + rev_negl[[8]] + rev_eq[[8]]
```






```{r}
# # Notes before my brain switches off completely
# * When I decreased the time step by 2 orders of magnitude, things crashed at step 6 insteras of step 3 :) 
# 
# * I am not sure if the algo knows that the CO2 produced in reaction 1 is the same as the CO2 consumed in reaction 2... 
#   * i.e. does it stop to sum the two CO2 columns and use the pooled CO2 for the next reaction? 
#     * https://github.com/rcannood/GillespieSSA/blob/master/R/ssa.run.R
# * If it doesn't 
#   * Should we implement the algo from scratch? 
#   * Should we only model forward reactions, making the probability of the forward reaction occuring a composite variable which captures the rates of the forwards and backwards reactiion? 
```
